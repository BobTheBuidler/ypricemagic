

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>y.utils.multicall &mdash; ypricemagic  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ypricemagic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">y</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../caching.html">Caching in ypricemagic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">CLI Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ypricemagic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">y.utils.multicall</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for y.utils.multicall</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">a_sync</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">brownie</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dank_mids</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">a_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">igather</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">faster_eth_abi.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InsufficientDataBytes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multicall</span><span class="w"> </span><span class="kn">import</span> <span class="n">Call</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">CannotHandleRequest</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">y</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y._decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">stuck_coro_debugger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y.contracts</span><span class="w"> </span><span class="kn">import</span> <span class="n">Contract</span><span class="p">,</span> <span class="n">contract_creation_block</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AddressOrContract</span><span class="p">,</span> <span class="n">AnyAddressType</span><span class="p">,</span> <span class="n">Block</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">continue_if_call_reverted</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y.interfaces.multicall2</span><span class="w"> </span><span class="kn">import</span> <span class="n">MULTICALL2_ABI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y.networks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Network</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">y.utils.raw_calls</span><span class="w"> </span><span class="kn">import</span> <span class="n">_decimals</span><span class="p">,</span> <span class="n">_totalSupply</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">MULTICALL2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Mainnet</span><span class="p">:</span> <span class="s2">&quot;0x5BA1e12693Dc8F9c48aAD8770482f4739bEeD696&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Arbitrum</span><span class="p">:</span> <span class="s2">&quot;0x842eC2c7D803033Edf55E478F461FC547Bc54EB2&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Avalanche</span><span class="p">:</span> <span class="s2">&quot;0xdf2122931FEb939FB8Cf4e67Ea752D1125e18858&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">BinanceSmartChain</span><span class="p">:</span> <span class="s2">&quot;0xfF6FD90A470Aaa0c1B8A54681746b07AcdFedc9B&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Fantom</span><span class="p">:</span> <span class="s2">&quot;0xBAD2B082e2212DE4B065F636CA4e5e0717623d18&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Harmony</span><span class="p">:</span> <span class="s2">&quot;0x34b415f4d3b332515e66f70595ace1dcf36254c5&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Heco</span><span class="p">:</span> <span class="s2">&quot;0xd1F3BE686D64e1EA33fcF64980b65847aA43D79C&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Moonriver</span><span class="p">:</span> <span class="s2">&quot;0xaeF00A0Cf402D9DEdd54092D9cA179Be6F9E5cE3&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Polygon</span><span class="p">:</span> <span class="s2">&quot;0xc8E51042792d7405184DfCa245F2d27B94D013b6&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">xDai</span><span class="p">:</span> <span class="s2">&quot;0x9903f30c1469d8A2f415D4E8184C93BD26992573&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Aurora</span><span class="p">:</span> <span class="s2">&quot;0xe0e3887b158F7F9c80c835a61ED809389BC08d1b&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Cronos</span><span class="p">:</span> <span class="s2">&quot;0x5e954f5972EC6BFc7dECd75779F10d848230345F&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Optimism</span><span class="p">:</span> <span class="s2">&quot;0xcA11bde05977b3631167028862bE2a173976CA11&quot;</span><span class="p">,</span>  <span class="c1"># Multicall 3</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Base</span><span class="p">:</span> <span class="s2">&quot;0xcA11bde05977b3631167028862bE2a173976CA11&quot;</span><span class="p">,</span>  <span class="c1"># mc3</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Katana</span><span class="p">:</span> <span class="s2">&quot;0xcA11bde05977b3631167028862bE2a173976CA11&quot;</span><span class="p">,</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Berachain</span><span class="p">:</span> <span class="s2">&quot;0xcA11bde05977b3631167028862bE2a173976CA11&quot;</span><span class="p">,</span>
<span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">brownie</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="n">multicall</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">multicall2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">brownie</span><span class="o">.</span><span class="n">Contract</span><span class="o">.</span><span class="n">from_abi</span><span class="p">(</span><span class="s2">&quot;Multicall2&quot;</span><span class="p">,</span> <span class="n">MULTICALL2</span><span class="p">,</span> <span class="n">MULTICALL2_ABI</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">brownie</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Network</span><span class="o">.</span><span class="n">Harmony</span><span class="p">,</span> <span class="n">Network</span><span class="o">.</span><span class="n">Cronos</span><span class="p">]</span>
    <span class="k">else</span> <span class="n">Contract</span><span class="p">(</span><span class="n">MULTICALL2</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># the address doesn&#39;t matter, it just needs to have code</span>
<span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;0x608060405234801561001057600080fd5b50600436106100b45760003560e01c806372425d9d1161007157806372425d9d1461013d57806386d516e814610145578063a8b0574e1461014d578063bce38bd714610162578063c3077fa914610182578063ee82ac5e14610195576100b4565b80630f28c97d146100b9578063252dba42146100d757806327e86d6e146100f8578063399542e91461010057806342cbb15c146101225780634d2301cc1461012a575b600080fd5b6100c16101a8565b6040516100ce919061083b565b60405180910390f35b6100ea6100e53660046106bb565b6101ac565b6040516100ce9291906108ba565b6100c1610340565b61011361010e3660046106f6565b610353565b6040516100ce93929190610922565b6100c161036b565b6100c161013836600461069a565b61036f565b6100c161037c565b6100c1610380565b610155610384565b6040516100ce9190610814565b6101756101703660046106f6565b610388565b6040516100ce9190610828565b6101136101903660046106bb565b610533565b6100c16101a3366004610748565b610550565b4290565b8051439060609067ffffffffffffffff8111156101d957634e487b7160e01b600052604160045260246000fd5b60405190808252806020026020018201604052801561020c57816020015b60608152602001906001900390816101f75790505b50905060005b835181101561033a5760008085838151811061023e57634e487b7160e01b600052603260045260246000fd5b6020026020010151600001516001600160a01b031686848151811061027357634e487b7160e01b600052603260045260246000fd5b60200260200101516020015160405161028c91906107f8565b6000604051808303816000865af19150503d80600081146102c9576040519150601f19603f3d011682016040523d82523d6000602084013e6102ce565b606091505b5091509150816102f95760405162461bcd60e51b81526004016102f090610885565b60405180910390fd5b8084848151811061031a57634e487b7160e01b600052603260045260246000fd5b602002602001018190525050508080610332906109c2565b915050610212565b50915091565b600061034d60014361097b565b40905090565b43804060606103628585610388565b90509250925092565b4390565b6001600160a01b03163190565b4490565b4590565b4190565b6060815167ffffffffffffffff8111156103b257634e487b7160e01b600052604160045260246000fd5b6040519080825280602002602001820160405280156103eb57816020015b6103d8610554565b8152602001906001900390816103d05790505b50905060005b825181101561052c5760008084838151811061041d57634e487b7160e01b600052603260045260246000fd5b6020026020010151600001516001600160a01b031685848151811061045257634e487b7160e01b600052603260045260246000fd5b60200260200101516020015160405161046b91906107f8565b6000604051808303816000865af19150503d80600081146104a8576040519150601f19603f3d011682016040523d82523d6000602084013e6104ad565b606091505b509150915085156104d557816104d55760405162461bcd60e51b81526004016102f090610844565b604051806040016040528083151581526020018281525084848151811061050c57634e487b7160e01b600052603260045260246000fd5b602002602001018190525050508080610524906109c2565b9150506103f1565b5092915050565b6000806060610543600185610353565b9196909550909350915050565b4090565b60408051808201909152600081526060602082015290565b80356001600160a01b038116811461058357600080fd5b919050565b600082601f830112610598578081fd5b8135602067ffffffffffffffff808311156105b5576105b56109f3565b6105c2828385020161094a565b83815282810190868401865b8681101561068c57813589016040601f198181848f030112156105ef578a8bfd5b6105f88261094a565b6106038a850161056c565b81528284013589811115610615578c8dfd5b8085019450508d603f850112610629578b8cfd5b898401358981111561063d5761063d6109f3565b61064d8b84601f8401160161094a565b92508083528e84828701011115610662578c8dfd5b808486018c85013782018a018c9052808a01919091528652505092850192908501906001016105ce565b509098975050505050505050565b6000602082840312156106ab578081fd5b6106b48261056c565b9392505050565b6000602082840312156106cc578081fd5b813567ffffffffffffffff8111156106e2578182fd5b6106ee84828501610588565b949350505050565b60008060408385031215610708578081fd5b82358015158114610717578182fd5b9150602083013567ffffffffffffffff811115610732578182fd5b61073e85828601610588565b9150509250929050565b600060208284031215610759578081fd5b5035919050565b60008282518085526020808601955080818302840101818601855b848110156107bf57858303601f19018952815180511515845284015160408585018190526107ab818601836107cc565b9a86019a945050509083019060010161077b565b5090979650505050505050565b600081518084526107e4816020860160208601610992565b601f01601f19169290920160200192915050565b6000825161080a818460208701610992565b9190910192915050565b6001600160a01b0391909116815260200190565b6000602082526106b46020830184610760565b90815260200190565b60208082526021908201527f4d756c746963616c6c32206167677265676174653a2063616c6c206661696c656040820152601960fa1b606082015260800190565b6020808252818101527f4d756c746963616c6c206167677265676174653a2063616c6c206661696c6564604082015260600190565b600060408201848352602060408185015281855180845260608601915060608382028701019350828701855b8281101561091457605f198887030184526109028683516107cc565b955092840192908401906001016108e6565b509398975050505050505050565b6000848252836020830152606060408301526109416060830184610760565b95945050505050565b604051601f8201601f1916810167ffffffffffffffff81118282101715610973576109736109f3565b604052919050565b60008282101561098d5761098d6109dd565b500390565b60005b838110156109ad578181015183820152602001610995565b838111156109bc576000848401525b50505050565b60006000198214156109d6576109d66109dd565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052604160045260246000fdfea2646970667358221220c1152f751f29ece4d7bce5287ceafc8a153de9c2c633e3f21943a87d845bd83064736f6c63430008010033&quot;</span>

<span class="n">multicall_deploy_block</span> <span class="o">=</span> <span class="n">contract_creation_block</span><span class="p">(</span><span class="n">multicall2</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>


<div class="viewcode-block" id="multicall_same_func_no_input">
<a class="viewcode-back" href="../../../source/y.utils.html#y.multicall_same_func_no_input">[docs]</a>
<span class="nd">@a_sync</span><span class="o">.</span><span class="n">a_sync</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
<span class="nd">@stuck_coro_debugger</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">multicall_same_func_no_input</span><span class="p">(</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AnyAddressType</span><span class="p">],</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_None_on_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>

    <span class="n">addresses</span> <span class="o">=</span> <span class="p">[</span><span class="k">await</span> <span class="n">convert</span><span class="o">.</span><span class="n">to_address_async</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">]</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">igather</span><span class="p">(</span>
        <span class="n">Call</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="p">((</span><span class="n">address</span><span class="p">,</span> <span class="n">apply_func</span><span class="p">)),</span> <span class="n">block_id</span><span class="o">=</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addresses</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">call</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span></div>



<div class="viewcode-block" id="multicall_same_func_same_contract_different_inputs">
<a class="viewcode-back" href="../../../source/y.utils.html#y.multicall_same_func_same_contract_different_inputs">[docs]</a>
<span class="nd">@a_sync</span><span class="o">.</span><span class="n">a_sync</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
<span class="nd">@stuck_coro_debugger</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">multicall_same_func_same_contract_different_inputs</span><span class="p">(</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">AnyAddressType</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">],</span>
    <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_None_on_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="n">inputs</span>
    <span class="n">address</span> <span class="o">=</span> <span class="k">await</span> <span class="n">convert</span><span class="o">.</span><span class="n">to_address_async</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">igather</span><span class="p">(</span>
        <span class="p">(</span><span class="n">Call</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">[</span><span class="n">method</span><span class="p">,</span> <span class="nb">input</span><span class="p">],</span> <span class="p">[(</span><span class="nb">input</span><span class="p">,</span> <span class="n">apply_func</span><span class="p">)],</span> <span class="n">block_id</span><span class="o">=</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">),</span>
        <span class="n">return_exceptions</span><span class="o">=</span><span class="n">return_None_on_failure</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">return_None_on_failure</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[:]):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="n">continue_if_call_reverted</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">call</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span></div>



<div class="viewcode-block" id="multicall_decimals">
<a class="viewcode-back" href="../../../source/y.utils.html#y.multicall_decimals">[docs]</a>
<span class="nd">@a_sync</span><span class="o">.</span><span class="n">a_sync</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
<span class="nd">@stuck_coro_debugger</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">multicall_decimals</span><span class="p">(</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AddressOrContract</span><span class="p">],</span>
    <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_None_on_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>

    <span class="n">addresses</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">addresses</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">a_sync</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Call</span><span class="p">,</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s2">&quot;decimals()(uint256)&quot;</span><span class="p">,</span> <span class="n">block_id</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">decimals</span> <span class="k">async</span> <span class="k">for</span> <span class="n">address</span><span class="p">,</span> <span class="n">decimals</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">CannotHandleRequest</span><span class="p">,</span> <span class="n">InsufficientDataBytes</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># TODO investigate these</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">continue_if_call_reverted</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">a_sync</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">_decimals</span><span class="p">,</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">return_None_on_failure</span><span class="o">=</span><span class="n">return_None_on_failure</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">pop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="multicall_totalSupply">
<a class="viewcode-back" href="../../../source/y.utils.html#y.multicall_totalSupply">[docs]</a>
<span class="nd">@a_sync</span><span class="o">.</span><span class="n">a_sync</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
<span class="nd">@stuck_coro_debugger</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">multicall_totalSupply</span><span class="p">(</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AddressOrContract</span><span class="p">],</span>
    <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_None_on_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>

    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">CannotHandleRequest</span><span class="p">,</span> <span class="n">InsufficientDataBytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">multicall_same_func_no_input</span><span class="p">(</span>
            <span class="n">addresses</span><span class="p">,</span> <span class="s2">&quot;totalSupply()(uint256)&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="k">await</span> <span class="n">_totalSupply</span><span class="p">(</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span>
            <span class="n">return_None_on_failure</span><span class="o">=</span><span class="n">return_None_on_failure</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addresses</span>
    <span class="p">]</span></div>



<span class="c1"># yLazyLogger(logger)</span>
<div class="viewcode-block" id="fetch_multicall">
<a class="viewcode-back" href="../../../source/y.utils.html#y.fetch_multicall">[docs]</a>
<span class="nd">@a_sync</span><span class="o">.</span><span class="n">a_sync</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
<span class="nd">@stuck_coro_debugger</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_multicall</span><span class="p">(</span><span class="o">*</span><span class="n">calls</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># https://github.com/makerdao/multicall</span>
    <span class="n">multicall_input</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fn_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">contract</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">,</span> <span class="o">*</span><span class="n">fn_inputs</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">)</span>

        <span class="c1"># check that there aren&#39;t multiple functions with the same name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;_get_fn_from_args&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">_get_fn_from_args</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">)</span>

        <span class="n">fn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">multicall_input</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">contract</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">encode_input</span><span class="p">(</span><span class="o">*</span><span class="n">fn_inputs</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">multicall_deploy_block</span><span class="p">:</span>
        <span class="c1"># use state override to resurrect the contract prior to deployment</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">multicall2</span><span class="o">.</span><span class="n">tryAggregate</span><span class="o">.</span><span class="n">encode_input</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">multicall_input</span><span class="p">)</span>
        <span class="n">call</span> <span class="o">=</span> <span class="k">await</span> <span class="n">dank_mids</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">multicall2</span><span class="p">),</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span>
            <span class="n">block</span> <span class="ow">or</span> <span class="s2">&quot;latest&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">multicall2</span><span class="p">):</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;0x</span><span class="si">{</span><span class="n">multicall2</span><span class="o">.</span><span class="n">bytecode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}},</span>  <span class="c1"># type: ignore [dict-item, typeddict-item]</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">multicall2</span><span class="o">.</span><span class="n">tryAggregate</span><span class="o">.</span><span class="n">decode_output</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">multicall2</span><span class="o">.</span><span class="n">tryAggregate</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span> <span class="n">multicall_input</span><span class="p">,</span> <span class="n">block_identifier</span><span class="o">=</span><span class="n">block</span> <span class="ow">or</span> <span class="s2">&quot;latest&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fn_list</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ok</span><span class="p">,</span> <span class="s2">&quot;call failed&quot;</span>
            <span class="n">decoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">decode_output</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="n">InsufficientDataBytes</span><span class="p">):</span>
            <span class="n">decoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decoded</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, BobTheBuidler.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>