

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>y.prices.lending.compound &mdash; ypricemagic  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            ypricemagic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/modules.html">y</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ypricemagic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">y.prices.lending.compound</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for y.prices.lending.compound</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">a_sync</span>
<span class="kn">from</span> <span class="nn">a_sync.a_sync</span> <span class="kn">import</span> <span class="n">HiddenMethodDescriptor</span>
<span class="kn">from</span> <span class="nn">brownie</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">brownie.exceptions</span> <span class="kn">import</span> <span class="n">VirtualMachineError</span>
<span class="kn">from</span> <span class="nn">multicall</span> <span class="kn">import</span> <span class="n">Call</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Self</span>

<span class="kn">from</span> <span class="nn">y</span> <span class="kn">import</span> <span class="n">ENVIRONMENT_VARIABLES</span> <span class="k">as</span> <span class="n">ENVS</span>
<span class="kn">from</span> <span class="nn">y.classes.common</span> <span class="kn">import</span> <span class="n">ERC20</span><span class="p">,</span> <span class="n">ContractBase</span>
<span class="kn">from</span> <span class="nn">y.constants</span> <span class="kn">import</span> <span class="n">EEE_ADDRESS</span>
<span class="kn">from</span> <span class="nn">y.contracts</span> <span class="kn">import</span> <span class="n">Contract</span><span class="p">,</span> <span class="n">has_methods</span>
<span class="kn">from</span> <span class="nn">y.datatypes</span> <span class="kn">import</span> <span class="n">AddressOrContract</span><span class="p">,</span> <span class="n">AnyAddressType</span><span class="p">,</span> <span class="n">Block</span><span class="p">,</span> <span class="n">UsdPrice</span>
<span class="kn">from</span> <span class="nn">y.exceptions</span> <span class="kn">import</span> <span class="n">call_reverted</span>
<span class="kn">from</span> <span class="nn">y.networks</span> <span class="kn">import</span> <span class="n">Network</span>
<span class="kn">from</span> <span class="nn">y.utils.logging</span> <span class="kn">import</span> <span class="n">_gh_issue_request</span>
<span class="kn">from</span> <span class="nn">y.utils.raw_calls</span> <span class="kn">import</span> <span class="n">raw_call</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">TROLLERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Mainnet</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;comp&quot;</span><span class="p">:</span> <span class="s2">&quot;0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cream&quot;</span><span class="p">:</span> <span class="s2">&quot;0x3d5BC3c8d13dcB8bF317092d84783c2697AE9258&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ironbank&quot;</span><span class="p">:</span> <span class="s2">&quot;0xAB1c342C7bf5Ec5F02ADEA1c2270670bCa144CbB&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inverse&quot;</span><span class="p">:</span> <span class="s2">&quot;0x4dCf7407AE5C07f8681e1659f626E114A7667339&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unfederalreserve&quot;</span><span class="p">:</span> <span class="s2">&quot;0x3105D328c66d8d55092358cF595d54608178E9B5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="s2">&quot;0x95Af143a021DF745bc78e845b54591C53a8B3A51&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">BinanceSmartChain</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;venus&quot;</span><span class="p">:</span> <span class="s2">&quot;0xfD36E2c2a6789Db23113685031d7F16329158384&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Polygon</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;easyfi&quot;</span><span class="p">:</span> <span class="s2">&quot;0xcb3fA413B23b12E402Cfcd8FA120f983FB70d8E8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="s2">&quot;0x46220a07F071D1a821D68fA7C769BCcdA3C65430&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chumhum&quot;</span><span class="p">:</span> <span class="s2">&quot;0x1D43f6DA91e9EF6614dCe95bCef43E4d7b2bcFB5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cream&quot;</span><span class="p">:</span> <span class="s2">&quot;0x20CA53E2395FA571798623F1cFBD11Fe2C114c24&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Fantom</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;cream&quot;</span><span class="p">:</span> <span class="s2">&quot;0x4250A6D3BD57455d7C6821eECb6206F507576cD2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scream&quot;</span><span class="p">:</span> <span class="s2">&quot;0x260E596DAbE3AFc463e75B6CC05d8c46aCAcFB09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ola&quot;</span><span class="p">:</span> <span class="s2">&quot;0xD65eB596cFb5DE402678a12df651E0e588Dc3A81&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Avalanche</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;vee&quot;</span><span class="p">:</span> <span class="s2">&quot;0xA67DFeD73025b0d61F2515c531dd8D25D4Cfd0Db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vee2&quot;</span><span class="p">:</span> <span class="s2">&quot;0x43AAd7d8Bc661dfA70120865239529ED92Faa054&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vee3&quot;</span><span class="p">:</span> <span class="s2">&quot;0xeEf69Cab52480D2BD2D4A3f3E8F5CcfF2923f6eF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cream&quot;</span><span class="p">:</span> <span class="s2">&quot;0x2eE80614Ccbc5e28654324a66A396458Fa5cD7Cc&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Arbitrum</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;cream&quot;</span><span class="p">:</span> <span class="s2">&quot;0xbadaC56c9aca307079e8B8FC699987AAc89813ee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;neku&quot;</span><span class="p">:</span> <span class="s2">&quot;0xD5B649c7d27C13a2b80425daEe8Cb6023015Dc6B&quot;</span><span class="p">,</span>
        <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="s2">&quot;0x3C13b172bf8BE5b873EB38553feC50F78c826284&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hund&quot;</span><span class="p">:</span> <span class="s2">&quot;0x0F390559F258eB8591C8e31Cf0905E97cf36ACE2&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">Network</span><span class="o">.</span><span class="n">Optimism</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ironbank&quot;</span><span class="p">:</span> <span class="s2">&quot;0xE0B57FEEd45e7D908f2d0DaCd26F113Cf26715BF&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{})</span>


<div class="viewcode-block" id="CToken">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken">[docs]</a>
<span class="k">class</span> <span class="nc">CToken</span><span class="p">(</span><span class="n">ERC20</span><span class="p">):</span>
<div class="viewcode-block" id="CToken.__init__">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">AnyAddressType</span><span class="p">,</span>
        <span class="n">comptroller</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Comptroller&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">asynchronous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a CToken instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            address: The address of the CToken.</span>
<span class="sd">            comptroller: An optional instance of :class:`~Comptroller` associated with this CToken.</span>
<span class="sd">            asynchronous: Whether to use asynchronous operations.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; ctoken = CToken(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ctoken_with_comptroller = CToken(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;, comptroller=my_comptroller)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">troller</span> <span class="o">=</span> <span class="n">comptroller</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rate_current</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="s2">&quot;exchangeRateCurrent()(uint)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CToken.get_price">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken.get_price">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skip_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">ENVS</span><span class="o">.</span><span class="n">SKIP_CACHE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsdPrice</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the price of the CToken in USD.</span>

<span class="sd">        Args:</span>
<span class="sd">            block: The block number to query. Defaults to the latest block.</span>
<span class="sd">            skip_cache: Whether to skip using the cache while fetching price data.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; price = await ctoken.get_price()</span>
<span class="sd">            &gt;&gt;&gt; price_at_block = await ctoken.get_price(block=12345678)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">troller</span><span class="p">:</span>
            <span class="c1"># We can use the protocol&#39;s oracle which will be quick (if it works)</span>
            <span class="n">underlying_per_ctoken</span><span class="p">,</span> <span class="n">underlying_price</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">underlying_per_ctoken</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_underlying_price</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">underlying_price</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">UsdPrice</span><span class="p">(</span><span class="n">underlying_per_ctoken</span> <span class="o">*</span> <span class="n">underlying_price</span><span class="p">)</span>

        <span class="c1"># Or we can just price the underlying token ourselves</span>
        <span class="n">underlying</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__underlying__</span>
        <span class="n">underlying_per_ctoken</span><span class="p">,</span> <span class="n">underlying_price</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">underlying_per_ctoken</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">underlying</span><span class="o">.</span><span class="n">price</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">UsdPrice</span><span class="p">(</span><span class="n">underlying_per_ctoken</span> <span class="o">*</span> <span class="n">underlying_price</span><span class="p">)</span></div>


<div class="viewcode-block" id="CToken.underlying">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken.underlying">[docs]</a>
    <span class="nd">@a_sync</span><span class="o">.</span><span class="n">aka</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">underlying</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ERC20</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the underlying ERC20 token for this CToken.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of :class:`~ERC20` representing the underlying token.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; underlying_token = await ctoken.underlying</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sourcery skip: use-or-for-fallback</span>
        <span class="n">underlying</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_method</span><span class="p">(</span>
            <span class="s2">&quot;underlying()(address)&quot;</span><span class="p">,</span> <span class="n">return_response</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># this will run for gas coin markets like cETH, crETH</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">underlying</span><span class="p">:</span>
            <span class="n">underlying</span> <span class="o">=</span> <span class="n">EEE_ADDRESS</span>
        <span class="k">return</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">underlying</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span><span class="p">)</span></div>


    <span class="n">__underlying__</span><span class="p">:</span> <span class="n">HiddenMethodDescriptor</span><span class="p">[</span><span class="n">Self</span><span class="p">,</span> <span class="n">ERC20</span><span class="p">]</span>

<div class="viewcode-block" id="CToken.underlying_per_ctoken">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken.underlying_per_ctoken">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">underlying_per_ctoken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the exchange rate of the CToken, adjusted for decimals.</span>

<span class="sd">        This method calculates the amount of underlying tokens per CToken by</span>
<span class="sd">        multiplying the exchange rate by a factor based on the difference in</span>
<span class="sd">        decimals between the CToken and its underlying token.</span>

<span class="sd">        Args:</span>
<span class="sd">            block: The block number to query. Defaults to the latest block.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; amount = await ctoken.underlying_per_ctoken()</span>
<span class="sd">            &gt;&gt;&gt; amount_at_block = await ctoken.underlying_per_ctoken(block=12345678)</span>

<span class="sd">        See Also:</span>
<span class="sd">            - :meth:`exchange_rate`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">underlying</span><span class="p">:</span> <span class="n">ERC20</span>
        <span class="n">exchange_rate</span><span class="p">,</span> <span class="n">decimals</span><span class="p">,</span> <span class="n">underlying</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rate</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__decimals__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__underlying__</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">exchange_rate</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">decimals</span> <span class="o">-</span> <span class="k">await</span> <span class="n">underlying</span><span class="o">.</span><span class="n">__decimals__</span><span class="p">)</span></div>


    <span class="c1"># yLazyLogger(logger)</span>
<div class="viewcode-block" id="CToken.exchange_rate">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken.exchange_rate">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">exchange_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current exchange rate of the CToken.</span>

<span class="sd">        Args:</span>
<span class="sd">            block: The block number to query. Defaults to the latest block.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; rate = await ctoken.exchange_rate()</span>
<span class="sd">            &gt;&gt;&gt; rate_at_block = await ctoken.exchange_rate(block=12345678)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exchange_rate</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rate_current</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span><span class="n">block_id</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">call_reverted</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="n">exchange_rate</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">exchange_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NOTE: Sometimes this works, not sure why</span>
            <span class="n">contract</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Contract</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exchange_rate</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">exchangeRateCurrent</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                    <span class="n">block_identifier</span><span class="o">=</span><span class="n">block</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;borrow rate is absurdly high&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="k">raise</span>
                <span class="n">exchange_rate</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">exchange_rate</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span></div>


<div class="viewcode-block" id="CToken.get_underlying_price">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.CToken.get_underlying_price">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_underlying_price</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skip_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">ENVS</span><span class="o">.</span><span class="n">SKIP_CACHE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the price of the underlying token in USD.</span>

<span class="sd">        Args:</span>
<span class="sd">            block: The block number to query. Defaults to the latest block.</span>
<span class="sd">            skip_cache: Whether to skip using the cache while fetching price data.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; price = await ctoken.get_underlying_price()</span>
<span class="sd">            &gt;&gt;&gt; price_at_block = await ctoken.get_underlying_price(block=12345678)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">oracle</span><span class="p">:</span> <span class="n">Contract</span>
        <span class="n">underlying</span><span class="p">:</span> <span class="n">ERC20</span>
        <span class="c1"># always query the oracle in case it was changed</span>
        <span class="n">oracle</span><span class="p">,</span> <span class="n">underlying</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troller</span><span class="o">.</span><span class="n">oracle</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__underlying__</span>
        <span class="p">)</span>
        <span class="n">price</span><span class="p">,</span> <span class="n">underlying_decimals</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="n">oracle</span><span class="o">.</span><span class="n">getUnderlyingPrice</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">block_identifier</span><span class="o">=</span><span class="n">block</span><span class="p">),</span>
            <span class="n">underlying</span><span class="o">.</span><span class="n">__decimals__</span><span class="p">,</span>
            <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="c1"># TODO debug why this occurs and refactor. only found on arbitrum cream</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ENVS</span><span class="o">.</span><span class="n">CONTRACT_THREADS</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="n">oracle</span><span class="o">.</span><span class="n">getUnderlyingPrice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">block_identifier</span><span class="o">=</span><span class="n">block</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">VirtualMachineError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span>
                    <span class="s2">&quot;revert: grace period not over&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;revert: Chainlink feeds are not being updated&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;revert: Feed not found&quot;</span><span class="p">,</span>
                <span class="p">}:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">raise</span>
        <span class="n">price</span> <span class="o">/=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">36</span> <span class="o">-</span> <span class="n">underlying_decimals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">price</span></div>
</div>



<div class="viewcode-block" id="Comptroller">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Comptroller">[docs]</a>
<span class="k">class</span> <span class="nc">Comptroller</span><span class="p">(</span><span class="n">ContractBase</span><span class="p">):</span>
<div class="viewcode-block" id="Comptroller.__init__">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Comptroller.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyAddressType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">asynchronous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Comptroller instance.</span>

<span class="sd">        You must provide either an address or a key. If both are provided, the key will be used to look up the address.</span>

<span class="sd">        Args:</span>
<span class="sd">            address: The address of the Comptroller.</span>
<span class="sd">            key: The key associated with the Comptroller in the TROLLERS dictionary.</span>
<span class="sd">            asynchronous: Whether to use asynchronous operations.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; comptroller = Comptroller(address=&quot;0x1234567890abcdef1234567890abcdef12345678&quot;)</span>
<span class="sd">            &gt;&gt;&gt; comptroller_with_key = Comptroller(key=&quot;comp&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">address</span> <span class="ow">or</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Must provide either an address or a key&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">address</span> <span class="ow">and</span> <span class="n">key</span>
        <span class="p">),</span> <span class="s2">&quot;Must provide either an address or a key, not both&quot;</span>

        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">TROLLERS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">TROLLERS</span> <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="n">TROLLERS</span><span class="p">[</span><span class="n">key</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Comptroller </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2">&#39;&gt;&quot;</span>

    <span class="c1"># yLazyLogger(logger)</span>
<div class="viewcode-block" id="Comptroller.__contains__">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Comptroller.__contains__">[docs]</a>
    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">:</span> <span class="n">AnyAddressType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a token address is contained within the Comptroller&#39;s markets.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_address: The address of the token to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the token address is in the Comptroller&#39;s markets, False otherwise.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; &quot;0x1234567890abcdef1234567890abcdef12345678&quot; in comptroller</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;self.asynchronous&#39; must be False to use Comptroller.__contains__&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">token_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markets</span></div>


<div class="viewcode-block" id="Comptroller.markets">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Comptroller.markets">[docs]</a>
    <span class="nd">@a_sync</span><span class="o">.</span><span class="n">aka</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">markets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">CToken</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the markets associated with this Comptroller.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of :class:`~CToken` instances representing the markets.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; markets = await comptroller.markets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_method</span><span class="p">(</span>
            <span class="s2">&quot;getAllMarkets()(address[])&quot;</span><span class="p">,</span> <span class="n">return_response</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;had trouble loading markets for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">markets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">CToken</span><span class="p">(</span><span class="n">market</span><span class="p">,</span> <span class="n">comptroller</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">market</span> <span class="ow">in</span> <span class="n">response</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;loaded </span><span class="si">%s</span><span class="s2"> markets for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">markets</span></div>


    <span class="n">__markets__</span> <span class="o">=</span> <span class="n">HiddenMethodDescriptor</span><span class="p">[</span><span class="n">Self</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">CToken</span><span class="p">]]</span>

<div class="viewcode-block" id="Comptroller.oracle">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Comptroller.oracle">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Contract</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the oracle contract associated with this Comptroller.</span>

<span class="sd">        Args:</span>
<span class="sd">            block: The block number to query. Defaults to the latest block.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; oracle = await comptroller.oracle()</span>
<span class="sd">            &gt;&gt;&gt; oracle_at_block = await comptroller.oracle(block=12345678)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Contract</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oracle</span> <span class="o">=</span> <span class="k">await</span> <span class="n">contract</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span><span class="n">block_identifier</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO debug why this occurs and refactor. only found on arbitrum cream</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">call_reverted</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="n">oracle</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">oracle</span><span class="p">(</span><span class="n">block_identifier</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">Contract</span><span class="o">.</span><span class="n">coroutine</span><span class="p">(</span><span class="n">oracle</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Compound">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Compound">[docs]</a>
<span class="k">class</span> <span class="nc">Compound</span><span class="p">(</span><span class="n">a_sync</span><span class="o">.</span><span class="n">ASyncGenericSingleton</span><span class="p">):</span>
<div class="viewcode-block" id="Compound.__init__">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Compound.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a Compound instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            asynchronous: Whether to use asynchronous operations.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; compound = Compound()</span>
<span class="sd">            &gt;&gt;&gt; compound_async = Compound(asynchronous=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span> <span class="o">=</span> <span class="n">asynchronous</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trollers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">protocol</span><span class="p">:</span> <span class="n">Comptroller</span><span class="p">(</span><span class="n">troller</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">troller</span> <span class="ow">in</span> <span class="n">TROLLERS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Compound.__contains__">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Compound.__contains__">[docs]</a>
    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">:</span> <span class="n">AddressOrContract</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a token address is a Compound market.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_address: The address of the token to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the token address is a Compound market, False otherwise.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; &quot;0x1234567890abcdef1234567890abcdef12345678&quot; in compound</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;self.asynchronous&#39; must be False and the event loop must not be running&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compound_market</span><span class="p">(</span><span class="n">token_address</span><span class="p">)</span></div>


<div class="viewcode-block" id="Compound.get_troller">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Compound.get_troller">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_troller</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">:</span> <span class="n">AddressOrContract</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Comptroller</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Comptroller associated with a token address.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_address: The address of the token.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of :class:`~Comptroller` if found, None otherwise.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; troller = await compound.get_troller(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trollers</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">troller</span><span class="p">,</span> <span class="n">markets</span> <span class="ow">in</span> <span class="n">Comptroller</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trollers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">token_address</span> <span class="ow">in</span> <span class="n">markets</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">troller</span></div>


<div class="viewcode-block" id="Compound.is_compound_market">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Compound.is_compound_market">[docs]</a>
    <span class="nd">@a_sync</span><span class="o">.</span><span class="n">a_sync</span><span class="p">(</span><span class="n">ram_cache_ttl</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_compound_market</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">:</span> <span class="n">AddressOrContract</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a token address is a Compound market.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_address: The address of the token to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the token address is a Compound market, False otherwise.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; is_market = await compound.is_compound_market(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_troller</span><span class="p">(</span><span class="n">token_address</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># NOTE: Workaround for pools that have since been revoked</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">has_methods</span><span class="p">(</span>
            <span class="n">token_address</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;isCToken()(bool)&quot;</span><span class="p">,</span> <span class="s2">&quot;comptroller()(address)&quot;</span><span class="p">,</span> <span class="s2">&quot;underlying()(address)&quot;</span><span class="p">),</span>
            <span class="n">sync</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__notify_if_unknown_comptroller</span><span class="p">(</span><span class="n">token_address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Compound.get_price">
<a class="viewcode-back" href="../../../../source/y.prices.lending.html#y.prices.lending.compound.Compound.get_price">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">token_address</span><span class="p">:</span> <span class="n">AnyAddressType</span><span class="p">,</span>
        <span class="n">block</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">ENVS</span><span class="o">.</span><span class="n">SKIP_CACHE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UsdPrice</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the price of a token in USD.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_address: The address of the token.</span>
<span class="sd">            block: The block number to query. Defaults to the latest block.</span>
<span class="sd">            skip_cache: Whether to skip using the cache while fetching price data.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; price = await compound.get_price(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;)</span>
<span class="sd">            &gt;&gt;&gt; price_at_block = await compound.get_price(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;, block=12345678)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">troller</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_troller</span><span class="p">(</span><span class="n">token_address</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">CToken</span><span class="p">(</span>
            <span class="n">token_address</span><span class="p">,</span> <span class="n">comptroller</span><span class="o">=</span><span class="n">troller</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">__notify_if_unknown_comptroller</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">:</span> <span class="n">AddressOrContract</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notify if a Comptroller is unknown to ypricemagic.</span>

<span class="sd">        Args:</span>
<span class="sd">            token_address: The address of the token.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; await compound.__notify_if_unknown_comptroller(&quot;0x1234567890abcdef1234567890abcdef12345678&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comptroller</span> <span class="o">=</span> <span class="k">await</span> <span class="n">raw_call</span><span class="p">(</span>
            <span class="n">token_address</span><span class="p">,</span> <span class="s2">&quot;comptroller()&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;address&quot;</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">comptroller</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trollers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">_gh_issue_request</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Comptroller </span><span class="si">{</span><span class="n">comptroller</span><span class="si">}</span><span class="s2"> is unknown to ypricemagic.&quot;</span><span class="p">,</span> <span class="n">logger</span>
            <span class="p">)</span></div>



<span class="n">compound</span><span class="p">:</span> <span class="n">Compound</span> <span class="o">=</span> <span class="n">Compound</span><span class="p">(</span><span class="n">asynchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, BobTheBuidler.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>